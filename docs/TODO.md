# LuckyReels 待优化清单

## 玩家角度

### 🔴 高优先级

| 功能 | 当前状态 | 建议 |
|------|----------|------|
| **教程系统** | 无 | 添加新手引导，解释符号、协同、租金机制 |
| **成就系统** | 无 | 添加成就解锁，增加重玩价值 |
| **统计面板** | 无 | 显示游戏统计：总金币、最高楼层、游戏时长等 |
| **暂停菜单** | 仅 ESC 返回主菜单 | 添加暂停界面，显示帮助、设置、继续选项 |

### 🟡 中优先级

| 功能 | 当前状态 | 建议 |
|------|----------|------|
| **音量调节** | 设置中无滑块 | 添加音乐/音效音量滑块 |
| **符号图鉴** | 无 | 收集并查看所有符号的详细信息 |
| **遗物图鉴** | 无 | 收集并查看所有遗物的详细信息 |
| **多存档槽** | 单存档 | 支持多个存档槽位 |
| **难度选择** | 无 | 简单/普通/困难模式 |
| **每日挑战** | 无 | 固定种子的每日挑战模式 |

### 🟢 低优先级

| 功能 | 当前状态 | 建议 |
|------|----------|------|
| **屏幕震动选项** | 无法关闭 | 添加开关 |
| **色盲模式** | 无 | 符号添加形状区分 |
| **快捷键提示** | 无 | 显示可用快捷键 |
| **游戏速度** | 固定 | 添加 1x/2x/3x 速度选项 |

---

## 开发者角度

### 🔴 高优先级 - 代码质量

| 问题 | 文件 | 行数 | 建议 |
|------|------|------|------|
| **ui.lua 过大** | `src/ui.lua` | 1744 | 拆分为模块化结构 |
| **effects.lua 过大** | `src/effects.lua` | 1078 | 拆分粒子、屏幕、金币效果 |
| **character_loader.lua** | `src/character_loader.lua` | 796 | 拆分各格式加载器 |

#### ui.lua 拆分建议
```
src/ui/
├── init.lua          # 主入口，组合所有模块
├── common.lua        # 通用函数（printOutlined, zones）
├── grid.lua          # 网格渲染
├── hud.lua           # HUD（金币、租金、楼层）
├── shop.lua          # 商店界面
├── overlays.lua      # 弹窗（游戏结束、事件、选择）
└── inventory.lua     # 背包界面
```

### 🟡 中优先级 - 代码规范

| 问题 | 说明 | 建议 |
|------|------|------|
| **缺少类型注解** | 无 LuaLS 注解 | 添加 `---@class`, `---@param`, `---@return` |
| **错误处理不足** | 很多地方无 pcall | 关键路径添加错误处理和日志 |
| **魔法数字** | 代码中有硬编码数值 | 移至 Config 或常量 |
| **重复代码** | 部分逻辑重复 | 提取公共函数 |

#### 类型注解示例
```lua
---@class Symbol
---@field key string
---@field char string
---@field color number[]
---@field base_value number

---@param key string
---@return Symbol|nil
function Registry.createSymbol(key)
```

### 🟡 中优先级 - 架构改进

| 问题 | 说明 | 建议 |
|------|------|------|
| **全局状态** | `_G.Fonts`, `_G.DEBUG_CHARACTER` | 使用依赖注入或模块化 |
| **循环依赖风险** | 部分模块相互引用 | 重构为单向依赖 |
| **事件系统** | EventBus 使用不一致 | 统一使用事件驱动 |

### 🟢 低优先级 - 工具和测试

| 问题 | 说明 | 建议 |
|------|------|------|
| **测试覆盖** | 84 个测试，缺少 UI 测试 | 添加 UI 和角色系统测试 |
| **性能监控** | 无 | 添加 FPS 显示和性能计时 |
| **热重载** | 无 | 开发时支持代码热重载 |
| **API 文档** | 仅 MODDING.md | 生成完整 API 文档 |
| **CI/CD** | 无 | 添加 GitHub Actions 自动测试 |

### 🟢 低优先级 - 国际化

| 问题 | 说明 | 建议 |
|------|------|------|
| **部分硬编码文本** | 一些 UI 文本未国际化 | 全面检查并移至 i18n |
| **缺少语言** | 仅中/英文 | 添加日语、韩语等 |
| **字体回退** | 无中文字体时显示方块 | 提供内置字体或更好的提示 |

---

## 优先级排序建议

### 第一阶段：代码重构
1. 拆分 `ui.lua`
2. 拆分 `effects.lua`
3. 添加类型注解

### 第二阶段：玩家体验
1. 添加教程系统
2. 添加暂停菜单
3. 添加音量设置

### 第三阶段：内容扩展
1. 成就系统
2. 符号/遗物图鉴
3. 难度选择

### 第四阶段：工具完善
1. 性能监控
2. 完整测试覆盖
3. CI/CD 流程

---

## 通用系统开发 (Project Dopamine)

> 来源: `DOPAMINE_GENERIC_SYSTEMS.md`
> 目标: 开发可复用的通用游戏系统

### 🔴 P0 - 核心系统 (Week 1)

| 系统 | 文件 | 说明 | 状态 |
|------|------|------|------|
| **Resource System** | `lib/resource.lua` | 通用资源管理（HP/Money/Volume等），支持修改器、派生资源、阈值事件 | ✅ |
| **State-Driven Sprite** | `lib/state_sprite.lua` | 状态驱动精灵系统，支持条件切换、分层、过渡动画 | ✅ |
| **Procedural Shape** | `lib/proc_shape.lua` | 程序化形状变形，支持贝塞尔曲线、物理晃动、参数绑定 | ✅ |

### 🟡 P1 - 交互系统 (Week 2)

| 系统 | 文件 | 说明 | 状态 |
|------|------|------|------|
| **Interactive Region** | `lib/interact_region.lua` | 交互区域系统，支持多边形/圆形、子区域、多种交互类型 | ✅ |
| **Conditional Dialogue** | `lib/dialogue.lua` | 条件对话系统，支持变量插值、优先级、冷却、对话树 | ✅ |
| **Weighted Event** | `lib/weighted_event.lua` | 加权事件系统，支持动态权重、保底机制、历史记录 | ✅ |

### 🟢 P2 - 高级系统 (Week 3)

| 系统 | 文件 | 说明 | 状态 |
|------|------|------|------|
| **Entity-Component System** | `lib/ecs.lua` | 轻量ECS，支持组件定义、系统定义、实体查询 | ⬜ |

### PR 策略

每个系统独立 PR，包含：
- `lib/[system].lua` - 核心代码
- `tests/test_[system].lua` - 单元测试
- `docs/[SYSTEM].md` - API 文档
- `examples/[system]_demo.lua` - 使用示例

**PR 顺序:** Resource → State Sprite → Weighted Event → Interactive Region → Dialogue → Proc Shape → ECS

---

## 快速修复清单

以下是可以快速完成的小改进：

- [ ] 添加 FPS 显示（F3 切换）
- [ ] 添加屏幕震动开关
- [ ] 添加游戏版本号显示
- [ ] 统一日志格式 `[模块] 消息`
- [ ] 添加 `.luacheckrc` 代码检查配置
- [ ] 添加 `.editorconfig` 统一代码风格
